<!-- AI Chat Widget -->
<div id="aiChatWidget" class="fixed bottom-4 right-4 z-50">
    <!-- Chat Toggle Button -->
    <button id="chatToggle" onclick="toggleAIChat()" 
            class="bg-primary hover:bg-secondary text-white rounded-full w-16 h-16 shadow-lg transition-all duration-300 flex items-center justify-center">
        <i id="chatIcon" class="fas fa-robot text-xl"></i>
    </button>

    <!-- Chat Window -->
    <div id="chatWindow" class="hidden absolute bottom-20 right-0 w-80 h-96 bg-white rounded-lg shadow-xl border border-gray-200 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-primary text-white p-4 rounded-t-lg flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fas fa-robot text-lg"></i>
                <span class="font-semibold">AI Assistant</span>
                <span id="aiStatus" class="w-2 h-2 bg-green-400 rounded-full"></span>
            </div>
            <button onclick="toggleAIChat()" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-2">
                <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                    <p class="text-sm text-gray-800">Hi! I'm your AI assistant for {{ club.name }}. How can I help you today?</p>
                    <p class="text-xs text-gray-500 mt-1">{{ current_time }}</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div id="quickActions" class="px-4 py-2 border-t border-gray-200">
            <div class="flex flex-wrap gap-2">
                <button onclick="sendQuickMessage('What services do you offer?')" 
                        class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full transition duration-200">
                    Services
                </button>
                <button onclick="sendQuickMessage('How do I book an appointment?')" 
                        class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full transition duration-200">
                    Bookings
                </button>
                <button onclick="sendQuickMessage('What are your membership options?')" 
                        class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full transition duration-200">
                    Membership
                </button>
                <button onclick="sendQuickMessage('What are your hours?')" 
                        class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full transition duration-200">
                    Hours
                </button>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-2">
                <input type="text" id="chatInput" placeholder="Ask me anything about {{ club.name }}..." 
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm"
                       onkeypress="handleChatKeyPress(event)">
                <button onclick="sendMessage()" 
                        class="bg-primary hover:bg-secondary text-white px-3 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">AI responses may take a moment</p>
        </div>
    </div>
</div>

<script>
let chatOpen = false;
let chatHistory = [];

// Toggle chat window
function toggleAIChat() {
    const chatWindow = document.getElementById('chatWindow');
    const chatIcon = document.getElementById('chatIcon');
    
    chatOpen = !chatOpen;
    
    if (chatOpen) {
        chatWindow.classList.remove('hidden');
        chatIcon.className = 'fas fa-times text-xl';
        document.getElementById('chatInput').focus();
    } else {
        chatWindow.classList.add('hidden');
        chatIcon.className = 'fas fa-robot text-xl';
    }
}

// Handle Enter key press
function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Send quick message
function sendQuickMessage(message) {
    document.getElementById('chatInput').value = message;
    sendMessage();
}

// Send message to AI
async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        // Send to AI API
        const response = await fetch('/api/v1/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                club_slug: '{{ club.slug }}',
                chat_history: chatHistory.slice(-10) // Send last 10 messages for context
            })
        });
        
        if (!response.ok) {
            throw new Error('AI service unavailable');
        }
        
        const data = await response.json();
        
        // Remove typing indicator
        removeTypingIndicator();
        
        // Add AI response
        addMessage(data.response, 'ai');
        
        // Update chat history
        chatHistory.push({role: 'user', content: message});
        chatHistory.push({role: 'assistant', content: data.response});
        
    } catch (error) {
        removeTypingIndicator();
        addMessage('Sorry, I\'m having trouble connecting right now. Please try again later.', 'ai', true);
        console.error('AI Chat Error:', error);
    }
}

// Add message to chat
function addMessage(message, sender, isError = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    const isUser = sender === 'user';
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    messageDiv.className = `flex items-start space-x-2 ${isUser ? 'justify-end' : ''}`;
    
    if (isUser) {
        messageDiv.innerHTML = `
            <div class="bg-primary text-white rounded-lg p-3 max-w-xs">
                <p class="text-sm">${message}</p>
                <p class="text-xs text-blue-200 mt-1">${timestamp}</p>
            </div>
            <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-gray-600 text-sm"></i>
            </div>
        `;
    } else {
        const bgColor = isError ? 'bg-red-100' : 'bg-gray-100';
        const textColor = isError ? 'text-red-800' : 'text-gray-800';
        
        messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                <i class="fas fa-robot text-white text-sm"></i>
            </div>
            <div class="${bgColor} rounded-lg p-3 max-w-xs">
                <p class="text-sm ${textColor}">${message}</p>
                <p class="text-xs text-gray-500 mt-1">${timestamp}</p>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show typing indicator
function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'flex items-start space-x-2';
    typingDiv.innerHTML = `
        <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
            <i class="fas fa-robot text-white text-sm"></i>
        </div>
        <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Remove typing indicator
function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Initialize chat with club context
document.addEventListener('DOMContentLoaded', function() {
    // Add initial context message
    setTimeout(() => {
        if (chatHistory.length === 0) {
            addMessage(`Welcome to ${club.name}! I can help you with bookings, membership questions, services, and more. What would you like to know?`, 'ai');
        }
    }, 1000);
});
</script>

<style>
/* Custom animations for chat */
@keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
        transform: translate3d(0,0,0);
    }
    40%, 43% {
        transform: translate3d(0, -8px, 0);
    }
    70% {
        transform: translate3d(0, -4px, 0);
    }
    90% {
        transform: translate3d(0, -2px, 0);
    }
}

.animate-bounce {
    animation: bounce 1.4s infinite;
}

/* Smooth transitions for chat */
#chatWindow {
    transition: all 0.3s ease-in-out;
}

#chatToggle {
    transition: all 0.3s ease-in-out;
}

#chatToggle:hover {
    transform: scale(1.05);
}
</style>
